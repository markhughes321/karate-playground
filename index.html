<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karate Playground</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e; color: #d4d4d4; height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    header {
      background: #252526; padding: 1rem 2rem;
      border-bottom: 1px solid #3e3e42;
      display: flex; justify-content: space-between; align-items: center;
    }
    h1 { font-size: 1.5rem; font-weight: 600; color: #569cd6; }
    button {
      background: #0e639c; color: white; border: none;
      padding: 0.5rem 1.5rem; border-radius: 4px; font-size: 0.9rem;
      cursor: pointer; transition: background 0.2s;
    }
    button:hover:not(:disabled) { background: #1177bb; }
    button:disabled { background: #3e3e42; cursor: not-allowed; opacity: 0.6; }
    main { flex: 1; display: flex; overflow: hidden; }
    .editor-section, .output-section {
      flex: 1; display: flex; flex-direction: column;
    }
    .editor-section { border-right: 1px solid #3e3e42; }
    .section-header {
      background: #252526; padding: 0.75rem 1rem;
      border-bottom: 1px solid #3e3e42; font-size: 0.9rem; font-weight: 500;
    }
    #editor { flex: 1; overflow: hidden; }
    #output {
      flex: 1; overflow-y: auto; padding: 1rem;
      font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem;
      line-height: 1.6; background: #1e1e1e;
    }
    .output-line { margin-bottom: 0.2rem; white-space: pre-wrap; }
    .success { color: #4ec9b0; font-weight: bold; }
    .error { color: #f48771; }
    .info { color: #569cd6; }
    .debug { color: #858585; font-size: 0.8rem; }
    .request { color: #dcdcaa; }
    .response { color: #4fc1ff; }
    footer {
      background: #252526; padding: 0.5rem 2rem;
      border-top: 1px solid #3e3e42; font-size: 0.8rem; color: #858585;
    }
  </style>
</head>
<body>
  <header>
    <h1>ü•ã Karate Playground</h1>
    <button id="runBtn" onclick="runTest()">Run Test</button>
  </header>

  <main>
    <section class="editor-section">
      <div class="section-header">üìù Karate Feature Editor</div>
      <div id="editor"></div>
    </section>

    <section class="output-section">
      <div class="section-header">üìä Test Results (Real-time Streaming)</div>
      <div id="output">Ready to run tests. Edit your Karate feature on the left and click "Run Test".</div>
    </section>
  </main>

  <footer>
    Running real Karate Framework 1.4.1 ‚Ä¢ Java 17 ‚Ä¢ Full feature support
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
  <script>
    let editor;

    require.config({
      paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }
    });

    require(['vs/editor/editor.main'], function() {
      // Register Karate/Gherkin language
      monaco.languages.register({ id: 'karate' });

      // Define Karate syntax highlighting
      monaco.languages.setMonarchTokensProvider('karate', {
        keywords: [
          'Feature', 'Background', 'Scenario', 'Scenario Outline', 'Examples',
          'Given', 'When', 'Then', 'And', 'But',
          'url', 'path', 'request', 'method', 'status', 'match', 'header',
          'param', 'def', 'set', 'assert', 'print', 'call', 'read',
          'configure', 'karate', 'response', 'responseTime'
        ],
        operators: ['==', '!=', '>', '<', '>=', '<='],
        tokenizer: {
          root: [
            [/@\w+/, 'tag'],
            [/\b(Feature|Background|Scenario|Scenario Outline|Examples)\b/, 'keyword.control'],
            [/\b(Given|When|Then|And|But)\b/, 'keyword.step'],
            [/\b(url|path|request|method|status|match|header|param|def|set|assert|print|call|read|configure|karate|response|responseTime)\b/, 'keyword'],
            [/\b(get|post|put|delete|patch)\b/, 'keyword.method'],
            [/\d+/, 'number'],
            [/"([^"\\]|\\.)*$/, 'string.invalid'],
            [/'([^'\\]|\\.)*$/, 'string.invalid'],
            [/"/, 'string', '@string_double'],
            [/'/, 'string', '@string_single'],
            [/"""/, 'string', '@string_multi'],
            [/#.*$/, 'comment'],
          ],
          string_double: [
            [/[^\\"]+/, 'string'],
            [/"/, 'string', '@pop']
          ],
          string_single: [
            [/[^\\']+/, 'string'],
            [/'/, 'string', '@pop']
          ],
          string_multi: [
            [/[^"]+/, 'string'],
            [/"""/, 'string', '@pop'],
            [/"/, 'string']
          ],
        }
      });

      // Define theme colors for Karate
      monaco.editor.defineTheme('karate-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'keyword.control', foreground: 'C586C0', fontStyle: 'bold' },
          { token: 'keyword.step', foreground: '569CD6', fontStyle: 'bold' },
          { token: 'keyword', foreground: '4EC9B0' },
          { token: 'keyword.method', foreground: 'DCDCAA', fontStyle: 'bold' },
          { token: 'tag', foreground: '4FC1FF' },
          { token: 'string', foreground: 'CE9178' },
          { token: 'comment', foreground: '6A9955', fontStyle: 'italic' },
          { token: 'number', foreground: 'B5CEA8' },
        ],
        colors: {}
      });

      // Create editor with Karate theme
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: `@createPost @smoke @positive
Feature: Create a new post

  Background:
    * url 'https://jsonplaceholder.typicode.com'

  Scenario: Create a post with valid data
    And path 'posts'
    And request
    """
    {
      "title": "My first post",
      "body": "This is an example post created for testing."
    }
    """
    When method post
    Then status 201
    And match response.title == 'My first post'
    And match response.body == 'This is an example post created for testing.'`,
        language: 'karate',
        theme: 'karate-dark',
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        scrollBeyondLastLine: false
      });
    });

    async function runTest() {
      const btn = document.getElementById('runBtn');
      const output = document.getElementById('output');

      btn.disabled = true;
      btn.textContent = 'Running...';
      output.innerHTML = '';

      appendOutput('Running test...', 'info');
      appendOutput('', '');

      const featureContent = editor.getValue();

      try {
        const response = await fetch('http://localhost:3001/run-test-stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ featureContent })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.substring(6));

              if (data.type === 'stdout') {
                // Colorize output
                let className = '';
                if (data.line.includes('POST') || data.line.includes('GET')) {
                  className = 'request';
                } else if (data.line.match(/^\d+ </)) {
                  className = 'response';
                } else if (data.line.includes('passed:') || data.line.includes('‚úì')) {
                  className = 'success';
                } else if (data.line.includes('ERROR') || data.line.includes('failed:') && !data.line.includes('failed: 0')) {
                  className = 'error';
                } else if (data.line.includes('DEBUG') || data.line.includes('INFO')) {
                  className = 'debug';
                } else if (data.line.includes('feature:') || data.line.includes('scenarios:')) {
                  className = 'info';
                }

                appendOutput(data.line, className);
              } else if (data.type === 'stderr') {
                appendOutput(data.line, 'error');
              } else if (data.type === 'exit') {
                if (data.code === 0) {
                  appendOutput('', '');
                  appendOutput('‚úÖ All tests passed', 'success');
                } else {
                  appendOutput('', '');
                  appendOutput(`‚ùå Test failed (exit code: ${data.code})`, 'error');
                }
              } else if (data.type === 'error') {
                appendOutput('‚ùå Error: ' + data.message, 'error');
              }
            }
          }
        }

      } catch (error) {
        appendOutput('', '');
        appendOutput('‚ùå Error: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Run Test';
      }
    }

    function appendOutput(text, className = '') {
      const div = document.createElement('div');
      div.className = `output-line ${className}`;
      div.textContent = text;
      const outputEl = document.getElementById('output');
      outputEl.appendChild(div);
      outputEl.scrollTop = outputEl.scrollHeight;
    }
  </script>
</body>
</html>
